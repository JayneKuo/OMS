# 自动化规则系统需求文档

## 1. 系统概述

自动化规则系统旨在通过可配置的规则来自动化处理订单相关的业务流程。系统支持多规则并行，可以根据不同的触发条件执行相应的操作。

## 2. 规则配置项

### 2.1 基本信息

| 字段 | 类型 | 必填 | 描述 |
|------|------|------|------|
| id | string | 是 | 规则唯一标识，系统自动生成 |
| name | string | 是 | 规则名称，用于识别规则用途 |
| enabled | boolean | 是 | 规则启用状态 |
| priority | number | 是 | 优先级(0-999)，数字越大优先级越高 |
| mutuallyExclusive | boolean | 是 | 是否互斥，设置为true时，该规则触发后会阻止其他规则执行 |

### 2.2 触发条件

#### 2.2.1 订单来源（Order Source）
- 类型：多选
- 选项：
  - website: 网站订单
  - app: 移动应用订单
  - third_party: 第三方平台订单
  - offline: 线下订单
- 逻辑：订单来源匹配任一选中项即可触发

#### 2.2.2 仓库（Warehouse）
- 类型：多选
- 数据来源：系统仓库列表
- 逻辑：订单关联仓库匹配任一选中项即可触发

#### 2.2.3 收货地址（Delivery Address）
- 匹配类型（matchType）：
  - fuzzy: 模糊匹配
  - exact: 精确匹配
- 匹配逻辑（logic）：
  - OR: 满足任一关键词
  - AND: 满足所有关键词
- 关键词（keywords）：支持多个关键词

#### 2.2.4 SKU条件（SKU Rules）
- SKU列表：支持多选
- 商品分类：支持多选
- 品牌：支持多选
- 价格区间：
  - 最小价格（可选）
  - 最大价格（可选）

### 2.3 通知配置

#### 2.3.1 邮件通知
- 支持配置多个邮箱地址
- 至少需要配置一个邮箱地址
- 邮箱格式需符合标准

#### 2.3.2 Webhook通知
- URL：webhook接口地址
- 支持测试接口连通性
- 可选配置，不是必须

## 3. 规则执行逻辑

### 3.1 规则触发顺序
1. 系统按优先级从高到低依次检查规则
2. 对于每条规则，检查其是否启用
3. 检查订单是否满足规则的所有触发条件
4. 如果满足条件，执行规则定义的操作

### 3.2 互斥规则处理
1. 当一个标记为互斥（mutuallyExclusive = true）的规则被触发时：
   - 该规则正常执行
   - 终止后续规则的检查，不再触发其他规则
2. 如果多个互斥规则同时满足条件：
   - 按优先级高的规则执行
   - 忽略优先级低的规则

### 3.3 规则匹配逻辑
1. 订单来源：满足任一选中的来源
2. 仓库：满足任一选中的仓库
3. 地址匹配：
   - Fuzzy模式：关键词出现在地址中即匹配
   - Exact模式：关键词完全匹配
   - OR逻辑：满足任一关键词
   - AND逻辑：必须满足所有关键词
4. SKU条件：
   - SKU列表：满足任一选中的SKU
   - 分类：满足任一选中的分类
   - 品牌：满足任一选中的品牌
   - 价格：在设定区间内（如果设置了区间）

## 4. 规则管理功能

### 4.1 规则操作
- 新增规则
- 编辑规则
- 克隆规则
- 删除规则
- 启用/禁用规则

### 4.2 规则列表功能
- 分页显示
- 搜索过滤
- 显示/隐藏已禁用规则
- 按优先级排序

### 4.3 数据展示
- 规则基本信息
- 触发条件可视化展示
- 通知配置信息
- 规则执行统计：
  - 最后触发时间
  - 触发次数

## 5. 安全性考虑

### 5.1 数据验证
- 必填字段验证
- 邮箱格式验证
- URL格式验证
- 数值范围验证

### 5.2 操作安全
- 删除操作需二次确认
- 批量操作需二次确认
- 关键字段修改需记录操作日志

## 6. 性能考虑

### 6.1 规则执行
- 单个订单规则检查耗时不超过500ms
- 支持并发处理多个订单
- 规则缓存机制，避免频繁读取数据库

### 6.2 界面响应
- 列表加载时间不超过1秒
- 规则保存响应时间不超过2秒
- 搜索响应时间不超过500ms

## 7. 扩展性设计

### 7.1 条件扩展
- 支持添加新的触发条件类型
- 支持自定义条件匹配逻辑

### 7.2 通知扩展
- 支持添加新的通知方式
- 支持自定义通知模板

### 7.3 动作扩展
- 预留动作配置接口
- 支持自定义规则动作 