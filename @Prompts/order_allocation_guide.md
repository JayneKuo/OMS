# 订单分配功能指南

## 1. 功能概述
- 功能定义：将订单分配给特定仓库进行处理的功能
- 适用范围：所有需要仓库处理的销售订单
- 基本流程：选择分配模式 → 选择仓库 → 确认分配

### 分配模式
1. 整单分配（Whole Order Allocation）：
   - 将整个订单分配给单个仓库
   - 所有商品必须由同一仓库处理
   - 要求仓库有足够库存支持所有SKU
   - 提示信息：
     - 中文：整单分配模式，所有商品将分配至同一仓库
     - 英文：Whole order allocation mode, all items will be allocated to one warehouse

2. 拆单分配（Split Order Allocation）：
   - 可将不同SKU分配给不同仓库
   - 支持按SKU级别分仓
   - 允许多仓库协同处理
   - 提示信息：
     - 中文：拆单分配模式，可将商品分配至不同仓库
     - 英文：Split order allocation mode, items can be allocated to different warehouses

## 2. 订单状态管理

### 可分配状态
1. Imported（已导入）状态：
   - 状态描述：订单初始状态，未进行分配
   - 分配规则：
     - 可自动分配
     - 可手动分配
     - 无库存预占
   - 特殊要求：
     - 检查订单完整性
     - 验证商品信息
   - 提示信息：
     - 中文：新订单等待分配
     - 英文：New order waiting for allocation

2. Pending（待处理）状态：
   - 状态描述：订单处于待处理状态
   - 分配规则：
     - 需确认hold原因
     - 可选择性分配
     - 特殊审批流程
   - 特殊要求：
     - 记录处理原因
     - 主管审批
   - 提示信息：
     - 中文：待处理订单分配
     - 英文：Allocate pending order

3. Deallocated（已解除分配）状态：
   - 状态描述：之前分配被取消的订单
   - 分配规则：
     - 可重新分配
     - 避免原失败仓库
     - 需特殊处理
   - 特殊要求：
     - 记录重分配原因
     - 检查历史记录
   - 提示信息：
     - 中文：订单重新分配
     - 英文：Reallocate order

4. Exception（异常）状态：
   - 状态描述：分配过程中出现异常的订单
   - 分配规则：
     - 特殊分配流程
     - 人工干预
     - 异常处理优先
   - 特殊要求：
     - 异常原因确认
     - 特殊审批流程
   - 提示信息：
     - 中文：异常订单重新分配
     - 英文：Reallocate exception order

### 不可分配状态
- Allocated（已分配）
- Shipping（发货中）
- Shipped（已发货）
- Cancelled（已取消）

### 状态流转规则
1. 正常分配流转：
   - Imported → Allocated
   - Pending → Allocated
   - Deallocated → Allocated

2. 异常分配流转：
   - Imported → Exception
   - Allocated → Exception
   - Exception → Allocated

## 3. 用户界面

### 界面组件
1. 分配模式选择：
   - Whole Order Allocation：整单分配
   - Split Order Allocation：拆单分配
   - 模式说明：显示当前模式的规则和限制

2. 仓库选择区域：
   - 仓库列表：显示可用仓库
   - 库存信息：实时库存数据（可用/总量）
   - WMS类型：仓库系统类型标识（V1/V2/Other）
   - 库存状态：颜色标识（绿/黄/红）
   - 操作按钮：
     - Add Warehouse：添加仓库行（仅拆单模式可用）
     - Remove Warehouse：删除仓库行（仅拆单模式可用）

3. 商品信息区：
   - SKU列表：显示所有待分配SKU
   - 订单数量：显示需求数量
   - 已分配数量：显示已分配数量
   - 剩余数量：显示未分配数量
   - 操作按钮：
     - Add SKU：添加SKU行（仅拆单模式可用）
     - Remove：删除SKU行（仅拆单模式可用）

4. 操作按钮：
   - Cancel：取消操作并关闭
   - Save Draft：保存草稿（仅拆单模式可用）
   - Confirm：确认分配

### 界面交互规则
1. 分配模式选择：
   - 切换模式时清空已选内容
   - 整单模式：隐藏多仓库操作按钮
   - 拆单模式：显示所有操作按钮

2. 仓库选择：
   - 整单模式：
     - 单选仓库
     - 自动检查所有SKU库存
     - 显示库存不足提示
   - 拆单模式：
     - 可选多个仓库
     - 按SKU检查库存
     - 支持动态添加仓库

3. 数量调整：
   - 整单模式：
     - 不可修改分配数量
     - 显示总数量信息
   - 拆单模式：
     - 可修改每个SKU分配数量
     - 实时验证分配数量
     - 自动计算剩余数量

## 4. 业务规则

### 分配模式规则
1. 整单分配规则：
   - 所选仓库必须有足够库存支持所有SKU
   - 不允许跨仓库分配
   - 一次性完成所有商品分配
   - 提示文案：
     - 成功：订单已成功整单分配（Order has been successfully allocated as a whole）
     - 失败：整单分配失败，请检查库存（Whole order allocation failed. Please check inventory）

2. 拆单分配规则：
   - 允许将不同SKU分配给不同仓库
   - 每个SKU只能分配给一个仓库
   - 所有SKU必须完成分配
   - 分配数量必须为正整数
   - 提示文案：
     - 成功：SKU已成功分配（SKUs have been successfully allocated）
     - 失败：SKU分配失败，请检查分配详情（SKU allocation failed. Please check allocation details）

### 库存规则
1. 库存检查：
   - 实时库存验证
   - 预占库存处理
   - 安全库存控制
   - 库存状态标识：
     - 绿色：库存充足（≥ 订单数量）
     - 黄色：库存不足（> 0 但 < 订单数量）
     - 红色：无库存（= 0）

2. 库存分配：
   - 库存锁定
   - 预占库存
   - 库存调整
   - 分配验证：
     - 分配数量不能超过订单数量
     - 分配数量必须为整数
     - 所有SKU都必须完成分配

### WMS规则
1. WMS类型处理：
   - WMS V1：同步分配，实时确认
   - WMS V2：异步分配，后台处理
   - Other WMS：需要手动确认
   - 提示文案：
     - WMS处理中：正在处理分配请求（Processing allocation request）
     - WMS确认：等待仓库确认（Waiting for warehouse confirmation）

2. WMS通信：
   - 库存同步
   - 状态更新
   - 异常处理
   - 处理规则：
     - 整单分配：统一发送给一个WMS
     - 拆单分配：分别发送给不同WMS

## 5. 权限控制

### 基本权限
1. 查看权限：
   - 库存查看
   - 状态查看
   - 历史查看

2. 操作权限：
   - 自动分配权限
   - 手动分配权限
   - 调整权限

### 特殊权限
1. 越权分配：
   - 库存不足时
   - 特殊客户订单
   - 紧急订单

2. 强制分配：
   - 系统管理员
   - 特殊情况
   - 记录日志

## 6. 异常处理

### 系统异常
1. WMS异常：
   - 中文：WMS系统连接异常
   - 英文：WMS system connection error

2. 库存异常：
   - 中文：库存数据异常
   - 英文：Inventory data error

### 业务异常
1. 库存不足：
   - 中文：库存不足，无法分配
   - 英文：Insufficient inventory

2. 并发冲突：
   - 中文：库存已被锁定
   - 英文：Inventory is locked

## 7. 数据处理

### 订单数据
1. 状态更新：
   - 订单状态
   - 分配状态
   - 处理记录

2. 关联数据：
   - 库存数据
   - 物流数据
   - 客户数据

### 库存数据
1. 库存更新：
   - 可用库存
   - 预占库存
   - 在途库存

2. 库存日志：
   - 变更记录
   - 操作记录
   - 异常记录

## 8. 通知机制

### 系统通知
1. 内部通知：
   - 仓库通知
   - 人员通知
   - 部门通知

2. 外部通知：
   - 客户通知
   - 供应商通知
   - 物流通知

### 异常通知
1. 库存异常：
   - 库存不足
   - 库存锁定
   - 数据不一致

2. 系统异常：
   - 连接异常
   - 数据异常
   - 处理超时

## 9. 日志记录

### 操作日志
1. 基本信息：
   - 操作时间
   - 操作人员
   - 操作类型
   - 操作结果

2. 详细信息：
   - 分配明细
   - 库存变化
   - 异常信息

### 查询功能
1. 日志查询：
   - 订单查询
   - 人员查询
   - 时间查询

2. 导出功能：
   - Excel导出
   - PDF导出
   - 自定义导出

## 10. 数据统计

### 统计维度
1. 基础统计：
   - 分配成功率
   - 异常率分析
   - 库存周转率
   - 效率分析

2. 趋势分析：
   - 分配趋势
   - 库存趋势
   - 异常趋势
   - 效率趋势 