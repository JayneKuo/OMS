# 订单取消功能指南

## 1. 功能概述
- 功能定义
- 适用范围
- 基本流程

### 取消模式
1. 整单取消：取消整个订单
2. 部分取消：仅取消选定的仓库分配

## 2. 订单状态管理

### 可取消状态
1. Imported（已导入）状态：
   - 状态描述：订单初始状态，未进入分仓流程的单据
   - 取消规则：
     - 可直接整单取消
     - 无需考虑库存释放
     - 无需考虑WMS系统
   - 特殊要求：
     - 记录取消原因
     - 记录操作人信息
   - 提示信息：
     - 中文：新导入订单取消
     - 英文：Cancel new imported order

2. Pending（待处理）状态：
   - 状态描述：手动或自动hold的单据，未进入分仓流程
   - 取消规则：
     - 可直接整单取消
     - 需确认hold原因
     - 无需考虑库存释放
   - 特殊要求：
     - 记录hold原因和取消原因
     - 需主管审批
   - 提示信息：
     - 中文：待处理订单取消，请确认hold原因
     - 英文：Cancel pending order, please confirm hold reason

3. Allocated（已分配）状态：
   - 状态描述：已完成仓库分配的订单
   - 取消规则：
     - 支持整单取消和部分取消
     - 需要处理库存释放
     - 需要通知相关仓库
   - 特殊要求：
     - 检查WMS状态
     - 确认库存预占状态
     - 分仓库处理取消
   - 提示信息：
     - 中文：已分配订单取消，将释放库存
     - 英文：Cancel allocated order, inventory will be released

4. Exception（异常）状态：
   - 状态描述：因库存不足等原因导致异常的订单
   - 取消规则：
     - 支持整单取消和部分取消
     - 需要处理已分配的库存
     - 需要记录异常原因
   - 特殊要求：
     - 确认异常原因
     - 处理异常子单
     - 可能需要特殊审批
   - 提示信息：
     - 中文：异常订单取消，请确认异常原因
     - 英文：Cancel exception order, please confirm exception reason

5. Warehouse Processing（仓库处理中）状态：
   - 状态描述：仓库已开始处理的订单
   - 取消规则：
     - 需要先确认仓库处理进度
     - 可能产生额外费用
     - 需要WMS系统确认
   - 特殊要求：
     - 检查处理进度
     - 确认费用情况
     - 高级管理员审批
   - 提示信息：
     - 中文：处理中订单取消，请确认仓库状态
     - 英文：Cancel processing order, please confirm warehouse status

### 不可取消状态
- Shipped（已发货）
- Short Shipped（部分发货）
- Cancelled（已取消）
- Cancelling（取消中）

### 状态流转规则
1. 整单取消流转：
   - Imported/Pending → Cancelled
   - Allocated → Cancelled
   - Exception → Cancelled
   - Deallocated → Cancelled
   - Warehouse Processing → Cancelled

2. 部分取消流转：
   - 子订单：Allocated → Cancelled
   - 主订单：保持原状态不变

## 3. 用户界面

### 界面组件
1. 取消模式选择（Cancel Mode）：
   - Cancel Entire Order：取消整个订单
   - Cancel Selected Warehouses：取消选中的仓库分配

2. 仓库选择区域：
   - 复选框：选择要取消的仓库
   - Sub-Order No.：子订单编号
   - Status：订单状态
   - Warehouse：仓库名称（含WMS类型标识）
   - Product：商品信息
   - Quantity：数量

3. 取消原因：
   - Reason（必填）：下拉选择取消原因
   - Remarks：输入额外备注信息

4. 操作按钮：
   - Back：返回不保存
   - Confirm Cancel：确认取消

### 界面交互规则
1. 取消模式选择：
   - 必选项
   - 影响后续表单显示

2. 仓库选择：
   - 部分取消模式下可用
   - 可多选
   - 显示WMS类型标识

3. 取消原因：
   - 必填项验证
   - 备注字数限制（500字）

## 4. 业务规则

### 取消模式规则
1. 整单取消规则：
   - 所有子订单必须可取消
   - 一次性取消所有内容
   - 不可部分保留

2. 部分取消规则：
   - 可选择多个子订单
   - 至少选择一个子订单
   - 其他子订单继续处理

### WMS处理规则
1. WMS类型处理：
   - WMS V1：同步取消，等待确认
   - WMS V2：异步取消，后台处理
   - Other WMS：需要手动确认

2. WMS状态检查：
   - 检查系统连接状态
   - 验证处理能力
   - 确认响应时间

### 库存处理规则
1. 预占库存处理：
   - 释放预占库存
   - 更新可用库存
   - 记录库存变动

2. 在途库存处理：
   - 确认库存位置
   - 处理在途数据
   - 更新库存状态

## 5. 权限控制

### 基本权限
1. 查看权限：
   - 所有用户可查看状态
   - 所有用户可查看历史

2. 操作权限：
   - 普通取消：客服人员
   - 强制取消：主管级别
   - 批量取消：管理员

### 特殊权限
1. WMS强制取消：
   - 仅系统管理员
   - 需要二次确认

2. 越权取消：
   - 需要上级审批
   - 记录特殊授权

## 6. 异常处理

### 系统异常
1. WMS连接异常：
   - 中文：仓库系统连接异常，请稍后重试
   - 英文：Warehouse system connection error. Please try again later

2. 数据保存异常：
   - 中文：取消数据保存失败，请重试
   - 英文：Failed to save cancellation data. Please try again

### 业务异常
1. 状态冲突：
   - 中文：订单状态已变更，无法取消
   - 英文：Order status has changed. Cannot cancel

2. 并发操作：
   - 中文：订单正在被其他用户处理，请稍后重试
   - 英文：Order is being processed by another user. Please try again later

## 7. 数据处理

### 订单数据处理
1. 状态更新：
   - 更新主订单状态
   - 更新子订单状态
   - 记录状态变更

2. 关联数据：
   - 更新库存数据
   - 更新统计数据
   - 更新客户订单

### 费用处理
1. 取消费用计算：
   - 仓储费用
   - 作业费用
   - 其他费用

2. 费用确认流程：
   - 费用核算
   - 费用审批
   - 费用记录

## 8. 通知机制

### 系统通知
1. 内部通知：
   - 通知相关仓库
   - 通知处理人员
   - 通知管理人员

2. 外部通知：
   - 通知客户
   - 发送邮件确认
   - 短信通知（可选）

## 9. 日志记录

### 操作日志
1. 基本信息：
   - 操作时间
   - 操作人员
   - 操作类型
   - 订单信息

2. 详细信息：
   - 取消原因
   - 取消范围
   - 处理结果
   - 异常信息

### 日志查询
1. 查询功能：
   - 订单号查询
   - 操作人查询
   - 时间范围查询
   - 取消原因查询

2. 导出功能：
   - Excel导出
   - PDF导出
   - 自定义导出

## 10. 数据统计

### 统计维度
1. 基础统计：
   - 取消率统计
   - 取消原因分析
   - 仓库取消分布
   - 客户取消行为

2. 趋势分析：
   - 日常取消报表
   - 异常取消分析
   - 趋势分析图表
   - 导出报表功能 